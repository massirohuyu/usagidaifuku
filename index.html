<!DOCTYPE html>
<html>
  <head>
    <title>Usagi Daifuku</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://cdn.rawgit.com/phi-jp/tmlib.js/0.4.4/build/tmlib.js" type="text/javascript"></script>
  </head>
  <body>
    
    <canvas id="world" width="640" height="480"></canvas>
    
    <script type="text/javascript">
      //確認用
      var test_app;
      
      (function(){
        
        var SCREEN_WIDTH    = 480, //12マス
            SCREEN_HEIGHT   = 640, //16マス
            SCREEN_CENTER_X = SCREEN_WIDTH/2,
            SCREEN_CENTER_Y = SCREEN_HEIGHT/2,
            BLOCK_WIDTH = 40,
            BLOCK_HEIGHT = 40,
            DIRECTION_LONG_TIME = 40;

        /*
        * メイン処理(ページ読み込み後に実行される)
        */
        tm.main(function() {
            // アプリケーション作成
            var app = tm.app.CanvasApp("#world");
            app.resize(SCREEN_WIDTH, SCREEN_HEIGHT); // リサイズ
            app.fitWindow();    // 自動フィット

            // シーンを切り替える
            app.replaceScene(MainScene());

            // 実行
            app.run();
        });
        
        tm.define("MainScene", {
            superClass: "tm.app.Scene",

            init: function() {
                // 親の初期化
                this.superInit();
                
                this.block = tm.app.Label('test').addChildTo(this);
                this.block.setPosition(SCREEN_CENTER_X ,SCREEN_CENTER_Y );
                this.on('pointingend', function(){
                  this.app.replaceScene(GameScene());
                })
                
            },

            update: function(app) {
              
            }
        });
        
        tm.define("GameScene", {
            superClass: "tm.app.Scene",

            init: function() {
                // 親の初期化
                this.superInit();

                // スプライト
                this.ctrlBlocks = this.createControlBlocks().addChildTo(this);
                this.ctrlBlocks.setPosition(SCREEN_CENTER_X ,0 );
                
                this.on('pointingstart', function(){
                  this.ctrlBlocks.rotation += 45;
                })
                
                //コントローラーの設置
                this.smpController = this.createSmpController().addChildTo(this);
                this.smpController.setPosition( 120 ,SCREEN_HEIGHT - 120 );
                
                //押しキー判定用変数
                this.longPressedKey = false; //長押し中のキー
                this.pressedTimes = 0;
                
            },

            update: function(app) {
                
                if( this.app.timer.frame%10 === 0 && this.ctrlBlocks.y < SCREEN_HEIGHT) {
                  this.ctrlBlocks.y += BLOCK_HEIGHT;
                }
                
                //キー操作判定
                var direction = this.smpController.getDirection();
                if(app.keyboard.getKey('left')) direction = 'left';
                else if(app.keyboard.getKey('right')) direction = 'right';
                
                if(direction && this.longPressedKey !== direction) {
                  this.longPressedKey = direction;
                  this.pressedTimes = 0;
                } else if(direction && this.longPressedKey === direction) {
                  if( this.pressedTimes < DIRECTION_LONG_TIME) {
                    direction = false;
                    this.pressedTimes ++;
                  }
                } else {
                  this.longPressedKey = false;
                  this.pressedTimes = 0;
                }
                
                
                if(direction === 'left'){
                  console.log('left');
                }
                if(direction === 'right'){
                  console.log('right');
                }
            },

            createControlBlocks: function() {
                var ctrlBlocks = tm.app.Shape(80,80);
                ctrlBlocks.addChild(this.createBlock());
                return ctrlBlocks;
            },

            createBlock: function() {
                var block = tm.app.RoundRectangleShape(40, 40);
                block.setFillStyle('#fff');
                block.setInteractive(true);
                return block;
            },

            createSmpController: function() {
                var smpController = tm.app.Shape(110, 110),
                  smpControllerBtn = tm.app.CircleShape(80, 80).setFillStyle('#888');
          
                smpController.addChild(tm.app.CircleShape(120, 120).setFillStyle('#fff'));
                smpController.addChild(smpControllerBtn);
                smpController.setInteractive(true);
                smpController.dx = 0;
                smpController.dy = 0;
                console.log(smpControllerBtn);
                smpController.on('pointingstart', function(e){
                  this.px = e.pointing.x;
                  this.py = e.pointing.y;
                })
                smpController.on('pointingmove', function(e){
                  this.dx = e.pointing.x - this.px;
                  this.dy = e.pointing.y - this.py;
                  smpControllerBtn.x = this.dx;
                  smpControllerBtn.y = this.dy;
                })
                smpController.on('pointingend', function(){
                  this.dx = 0;
                  this.dy = 0;
                  smpControllerBtn.x = 0;
                  smpControllerBtn.y = 0;
                })
                smpController.getDirection = function(){
                  var direction = false,
                      unreactedDist = 30;
                  if(Math.abs(this.dx) < unreactedDist && Math.abs(this.dy) < unreactedDist ){
                    return false;
                  }
                  
                  if(Math.abs(this.dx) > Math.abs(this.dy)){
                    if(this.dx > 0) direction = 'right';
                    else direction = 'left';
                  }
                  else if(Math.abs(this.dx) < Math.abs(this.dy)){
                    if(this.dy > 0) direction = 'down';
                    else direction = 'up';
                  }
                  
                  return direction;
                }
                return smpController;
            }
        });
        
      })();
    </script>
  </body>
</html>
